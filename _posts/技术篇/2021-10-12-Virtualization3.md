# 读《现代操作系统：原理与实现》第十一章 系统虚拟化 重点笔记：

基础设施即服务：Iaas Infrastructure as a service 云计算 **用户租用云服务商的虚拟机，在虚拟机中部署和运行自己的程序，降低了运载成本**

**云服务商则通过系统虚拟化技术，大大提高资源利用率**

有以下优点 ：服务器资源整合，提供小于实际投入使用的物理主机的资源

虚拟机能力方便 热迁移：无需停机或重启

下陷：一种特权级降低的情况，在虚拟化技术中通常由虚拟化监视器来完成

可虚拟化架构：所有的敏感指令都是特权指令，所有的敏感指令在非特权级执行时都会触发下陷。

弥补不可虚拟化架构缺陷方法：

#### 1.解释执行，每次对虚拟机内的每一条指令进行模拟，不依赖下陷

每次先读取虚拟机中的pc程序计数器，然后根据pc的值找到待模拟的指令，之后将指令解码最后根据解码结构运行相应的模拟函数更新虚拟机的寄存器内容或内存值，之后更新pc然后继续反复操作

[![50S5OP.jpg](https://z3.ax1x.com/2021/10/19/50S5OP.jpg)](https://imgtu.com/i/50S5OP)

2.动态二进制翻译

本质上以粗粒度基本块为单位，将一个基本块内的所有指令都翻译成最终的目标代码

[![509bxs.jpg](https://z3.ax1x.com/2021/10/19/509bxs.jpg)](https://imgtu.com/i/509bxs)

3.扫描与翻译

只需要模拟敏感指令

1. 在虚拟机执行前 所有内存被设置为不可执行 这样第一次执行时会触发缺页异常

   2.特权级改变 调用虚拟机监控器的缺页异常处理函数

​	3.控制流交给控制器，根据下陷地址找到异常指令地址，先查找缓存是否存在已经翻译过代码页，有就直接返回用户态

​	4.不存在则调用翻译模块

​    5.扫描翻译模块读取内存中待翻译的代码页内容，将敏感指令替换为触发下陷的特权指令，并放入缓存中

​	6.如果在后续虚拟机执行中遇到敏感指令 将下陷并通知VMM完成相应指令模拟操作

